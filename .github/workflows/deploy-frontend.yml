name: Deploy Frontend to Production

on:
    push:
        branches:
            - main
    workflow_dispatch: # Allow manual trigger

jobs:
    deploy:
        name: Build and Deploy Frontend
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"

            - name: Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: 8

            - name: Install dependencies
              run: pnpm install --no-frozen-lockfile

            - name: Build frontend
              run: pnpm build
              env:
                  VITE_API_URL: https://zhu-clan.emerj.net/api/v1/waitlist/subscribe
                  VITE_APP_NAME: "Storytime Waitlist"
                  VITE_APP_URL: https://zhu-clan.emerj.net

            - name: Deploy to server via SSH
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  port: 22
                  script: |
                      # Create deployment directory
                      sudo mkdir -p /var/www/storytime-waitlist/frontend

                      # Clean old files
                      sudo rm -rf /var/www/storytime-waitlist/frontend/*

            - name: Copy files to server
              uses: appleboy/scp-action@v0.1.4
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  port: 22
                  source: "dist/*"
                  target: "/tmp/frontend-deploy"
                  strip_components: 1

            - name: Move files and set permissions
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  port: 22
                  script: |
                      # Move files to final location
                      sudo cp -r /tmp/frontend-deploy/* /var/www/storytime-waitlist/frontend/

                      # Set correct permissions
                      sudo chown -R www-data:www-data /var/www/storytime-waitlist/frontend
                      sudo find /var/www/storytime-waitlist/frontend -type d -exec chmod 755 {} \;
                      sudo find /var/www/storytime-waitlist/frontend -type f -exec chmod 644 {} \;

                      # Clean up temp files
                      rm -rf /tmp/frontend-deploy

                      # Reload Nginx (optional, usually not needed for static files)
                      sudo systemctl reload nginx || true

                      echo "‚úÖ Frontend deployed successfully!"

            - name: Notify deployment status
              if: always()
              run: |
                  if [ "${{ job.status }}" == "success" ]; then
                    echo "üéâ Deployment successful! Visit https://zhu-clan.emerj.net"
                  else
                    echo "‚ùå Deployment failed!"
                  fi
